License
=======

Copyright (C) 2022 by Andreas Zenk

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.


Introduction
============

This software allows to do "tracing" of C++ function calls. More specifically,
it generates callout functions that are called on entry and exit of the "traced"
functions. Function parameters (for class member functions, this includes the
this-pointer) and return values can be inspected in these callout functions.

The calls to the traced functions still take place. A call to any of the traced
functions triggers following events in that order:
1. Call to the entry callout function.
2. Call to the traced function.
3. Call to the exit callout function.

If nothing is done in the callouts, the behaviour of the program is unchanged
(except for a small performance decrease due to additional function calls)
compared to the case without any tracing.

The software is designed so it can be "plugged in" an existing CMake project
with only minor changes.


Credits
=======

Ideas from sources were used in creation of this software:
- https://crascit.com/2016/04/09/using-ccache-with-cmake
- https://stackoverflow.com/questions/36084785/building-a-tool-immediately-so-it-can-be-used-later-in-same-cmake-run
- Below flowchart crreated with https://asciiflow.com/#/


Dependencies to other Software
==============================

Following software is required for this software to work. The version numbers
indicate the version with which this was tested, other versions may also work:
- CMake (3.24.0)
- Make (4.3)
- gcc (11.2.0)
- ld (2.38)
- Python (3.10.4)
    - PyYAML (5.4.1)
- nm/binutils (2.38)
- ccache (4.5.1, optional)

This software was developed and tested on Ubuntu 22.04.1 LTS with Linux kernel
5.15.0-46-generic x86_64.


Directory Structure
===================

Following is the directory structure of the software:

o
+- build.sh: Example script to build the tests.
+- run.sh: Example script to run the tests. build.sh must succeed to use this.
+- expected.txt: Used by test to check if all callouts were called as expected.
+- README.md: This file.
+- LICENSE.md: License description (BSD 0-clause)
+- CMakeLists.txt: Example how to include tracing into a CMake project.
+- Test: The C++ test code (example CMake project C++ code).
  +- main.cpp
  +- test.cpp
  +- test.h
  +- traced_functions.yml
  +- tracing_callouts.h
  +- tracing_callouts.cpp
+- Tracing: The part of the software required for actual usage.
  +- generated: Generated source code files will be placed in this directory.
    +- .gitkeep
  +- generators: Implementation of file generation.
    +- callout_declaration_generator.py
    +- callout_definition_generator.py
    +- __init__.py
    +- utils.py
    +- vtable_update_generator_clang.py
    +- vtable_update_generator_gcc.py
    +- wrapper_generator.py
  +- parser: Implementation of file parsing.
    +- function_info.py
    +- generated_file_parser.py
    +- __init__.py
    +- parameters.py
    +- parser_function_list.py
    +- parser_nm.py
    +- parser_structure_clang.py
    +- parser_structure_gcc.py
    +- user_code_info.py
    +- utils.py
    +- vtable_info.py
  +- CMakeLists.txt
  +- generate_callouts.py: Generation of callout functions.
  +- generate_callouts.sh
  +- generate_wrappers.py: Generation of linker functions and vtable update.
  +- generate_wrappers.sh
  +- __init__.py
  +- vtable_update_info.py
  +- wrapper_info.py
  +- launchcxx.in

Only static files are listed, files generated by the software are not listed.


Usage
=====

Relevant Files
--------------

For understanding how to use this software, understanding of following files is
very helpful.

### Tracing Configuration File

This file describes the functions to trace. Each function that is desired to be traced needs to be described in this file.  
Each function is described by a yaml list item of following structure:
```yaml
- function: "example::function::name"
  return: "example::return::type"
  level: "free"
  parameters:
  - "example::param::type"
  include: "#include \"example.h\""
```
The meaning of these elements is as follows:
- function: The name of the function.
- return: The return type of the function. Put "void" for constructors and
  destructors.
- level: The "kind" of function this is from following:
    - A function that is not member of a class or a static class member: "free"
    - A non-const member function: "member"
    - A const member function: "const"
- parameters: The parameter types of the function. It is **NOT** necessary to
  list the this-pointer of class member functions. If the function does not have
  any parameters (or it only has the this-pointer), this still needs to be
  present but shall be left empty (meaning the line after ```parameters:``` is
  ```include:```). The parameters **MUST** be listed in the same order as in
  the code.
- include: The header in which the function is declared. The header needs to be
  self-contained. This means, it must include all headers relevant for the
  function declaration (e.g. declaration of types for parameters/return value).

Further hints on this file:
- For all names (of the function as well as of types) the full namespace needs
  to be written.
- The include directive needs to be complete (with the ```#include```). The file
  path needs to be found from the include directories set in the CMake project
  of the traced C++ project. Plainly speaking, the (correct) include-directive
  the required header from some C++ source file of the project can be copied.
- If multiple overloads of a function are traced, each overload requires a
  dedicated list item.
- To trace template functions (this includes member functions of templated
  classes), the full template type needs to be specified.

This file is read by the software when it is executed. The location of this file
is set by the *TARGET_FILE* CMake variable.

An example of this file can be seen in ```Test/traced_functions.yml```.


### Callout Definition File

This file contains the definition of the entry and exit callout functions. Any
code can be put into these callout functions.

This file is re-generated each time this software runs (that is, each time the
CMake configuration takes place). Changes in explicitly marked areas (delimited
by specific comments) are preserved.
**Any changes outside of these areas are lost when the file is re-generated.**
A backup of this file is created before it is re-generated. This backup is
placed in the same directory the file itself is located in.

This file is generated to ```Tracing/generated/tracing_callouts.cpp```.
This file is explicitly **NOT** generated to the CMake binary directory because
it contains the code added to the callout functions which is information that
can not be generated by the build tool chain. This information is input that the
tool chain uses to generate what will later be placed to the binary directory.


Initial Setup
-------------

To add this software to an existing CMake project
- ensure the CMake variable *TRACE_NESTED_BUILD* is **NOT** set in any way
  (neither by CMake code nor by command line invocation of CMake).
- ensure that all file paths passed to CMake via command line (e.g. source and
  build directory) are absolute paths.
- ensure that the CMake build type is ```Debug```.
- set the CMake variable *TRACE_TARGET* to the name of the executable in which
  the tracing of function calls shall take place.
- set the CMake variable *TARGET_FILE* to the absolute path to the Tracing
  Configuration File.
- add the ```Tracing``` directory as subdirectory **after** all settings to the
  executable target selected for tracing have been done.

Refer to the CMakeLists.txt file in this directory for an example of how an
inclusion of this software into a CMake project could look like.


Usage after Setup
-----------------

After the initial setup is complete, the executable target selected for tracing
can be built using CMake. Refer to build.sh in this directory for an example how
CMake configuration and build can be done.

If you want to run the tests, copy ```Test/tracing_callouts.h``` and
```Test/tracing_callouts.cpp``` to ```Tracing/generated``` before building.

Changes to the Tracing Configuration File only take effect if the CMake project
is re-configured (removing all build artifacts and doing a clean build). It is
recommended to add the functions to trace to the Tracing Configuration File
before doing the initial CMake configuration.

The *TRACE_MANGLING_RESOLUTION_ALGORITHM* CMake variable can be used to select
how the build should behave:
- setting to "REBUILD": Most source files are compiled twice during first CMake
  configuration+build step. Build dependencies are intact so later builds
  only re-build changed files. This is the default setting. The duplicated build
  can be mitigated by use of ccache (will be used by this software if found).
- setting to "REUSE": Source files are compiled once. Build dependencies do not
  work properly, removing all build artifacts and doing a clean build is
  required so changes to files take effect. This setting is recommended for
  setups where a build always happens from a clean state (e.g. CI systems that
  use a new container environment for each job).

The ```Tracing/generated/tracing_callouts.cpp``` file is generated with the
CMake configuration. So at least one CMake configuration needs to be done after
the initial setup for this file to be available.

The general usage sequence is:
1. Fill Tracing Configuration file
2. Run CMake configuration
3. Build
4. Update Callout Definition file
5. Build


Limitations
===========

The namespace ```tracing``` is reserved, traced functions must not be located in
that namespace.

Overloads of following operators can not be traced:
- ```.*```
- ```->*```
- ```->```
- ```<=>```

Calls that happen through a function pointer can not be traced.

Tracing only works for function calls between compilation units. Especially
functions defined in headers can not be traced from files that include these
headers.  
For templates, explicit instantiation can be used in a dedicated cpp file. See
```Test/test.h``` and ```Test/test.cpp``` for an example of explicit
instantiation (search for ```FreeTemplateFunction```,
```Template<StringContainer>``` or ```class Template```).

Tracing only reliably works from entry to ```main()``` onwards, if traced
functions are called before the entry to ```main()```, callouts may or may not
be called. There should be no additional threads be created before the entry to
```main()``` as global data structures (vtables) are changed by the software at
that time.

Currently, only gcc is supported.

The CMake ```CXX_COMPILER_LAUNCHER``` property is set on the executable target
set for tracing. This may result in conflicts if this property is set by the
user (also by the ```CMMAKE_CXX_COMPILER_LAUNCHER``` CMake variable or the
```RULE_LAUNCH_COMPILE``` global CMake property).


Troubleshooting
===============

To tackle issues (build issues, the traced functions being not called, runtime
crashes, ...), please consider following suggestions:
- Delete the CMake build directory and reset ccache to do a fresh build.
- Re-check above ```Limitations``` section.
- Check the entry of the affected traced function in the Tracing Configuration
  file, refer to above section about that file for details on requirements on
  file content and format.
- Set the ```TRACE_BUILD_VERBOSE``` CMake variable to get additional output.
  Referring to below section about technical details may be helpful in
  understanding and interpreting this output.

Please note that it may take the author of this software several weeks to answer
questions as this is a beside-work project.


Technical Details about how this Software works
===============================================

The tracing is done using the ```--wrap``` linker option. That option allows
to redirect calls to and returns from a function to C functions whose
definitions must be provided.

To use this linker option, the mangled names of the traced functions are
required. These can be extracted from object files compiled from the source
files that contain the definition of the functions. As this information is
required at CMake configuration time, the compilation is done in a nested
run of CMake (CMake being executed from CMakeLists.txt with
```execute_process()```).

Once the object files are available, the mangled names are extracted using nm.
To be able to match the mangled names to the unmangled names, nm is executed
twice, once with and once without demangling. The demangled names are then
compared with the contents of the Tracing Configuration File to establish the
matching between mangled and unmangled names.  
To execute nm, the locations of the object files are required. They are read
from the compile_commands.json file.

The information from the Tracing Configuration File together with the mangled
names is used to generate the C functions for the ```--wrap``` linker option.
These functions are generated so they call the callout function that belongs to
this traced function.  
As these are C functions, the mangled names of the callout functions are also
required (calls generated into the C functions must use the mangled names of
the called C++ function). They are acquired by analyzing the object file of the
Callout Definition File.

This of course requires that the Callout Definition File is generated before the
compilation happens in the nested CMake run. To allow this, the Callout
Definition File can be generated from the information of the Tracing
Configuration File alone.  
To preserve user code in the callback functions, a previous version of the
Callout Definition File is (as far as it is present) parsed. The user code is
identified by specific comments that surround it.

With an implementation of this description up to this point, calls to normal
functions can be traced. However, tracing does not work for virtual functions
because calls to them are not redirected to the C functions even if the
```--wrap``` linker option is used on them.
The ```--wrap``` linker option works by replacing the linker symbols of the
function it is applied to at call site. But at the call site of a virtual
function call, the symbol of the virtual function is not known at compile time.
Instead of placing that symbol there, the compiler generates there a lookup in
the vtable to find which function to actually call.

To allow tracing of the virtual functions, the vtable itself is updated, a
function pointer to the C function is placed in it.  
Access to the vtable for this purpose is achieved by forward-declaring it. This
access is used to overwrite the respective part of the vtable with a function
pointer to the C function.  
To know what part of the vtable to overwrite, its memory layout is discovered by
parsing the file output by gcc when specifying the ```-fdump-lang-class```
option.


In short, this software first reads required information from the configuration
files and the output of other tools (nm, compiler) and then generates code from
this information to realize the function call tracing.

Following flowchart shows the different steps, the origin of their inputs and
further use of their outputs:


 +---------+
 │ Tracing │
 │ Config  │
 │ File    │
 +---------+
     ___
     | |
    _| |_
    \   /
     \ /
      V           /|         +---------------+
                 / +-------+ |               |
+------------+  /  Parse   | │    Callout    │
│            │  \          | │    Code       │
│ Generate   │   \ +-------+ │    Files      │   +--------+
│ Callout    │    \|         │               │   │ Target │
│ Code       │          |\   │               │   │ Source │
│            │  +-------+ \  │ Possibly      │   │ Files  │
│            │  | Generate \ │ existing from │   +--------+
+------------+  |          / │ previous run  │      ___
                +-------+ /  │               │      | |
                        |/   │               │      | |
                             +---------------+      | |
                                  ___               | |
                                  | |               | |
                                 _| |_             _| |_
                                 \   /             \   /
                                  \ /               \ /
                                   V                 V

                               +------------------------------------------+
                               │                                          │
                               │                                          │
                               │                                          │
                               │                 Compiler                 │
                               │                                          │
                               │                                          │
                               │                                          │
                               +------------------------------------------+
                                  ___               ___              ___
                                  │ │               | |              | |
                                  │ │              _| |_             │ │
                                  │ │              \   /             │ │
                                  │ │               \ /              │ │
                                  │ │                V               │ │
                                  │ │                                │ │
                                  │ │          +-----------+         │ │
                                  │ │          │ compile_  │         │ │
                                  │ │          │ commands. │         │ │
                                  │ │          │ json      │         │ │
                                 _│ │_         +-----------+        _│ │_
                                 \   /                              \   /
                                  \ /            +-----+             \ /
                                   V             |     |              V
                                                 |     |
                              +---------+   /|   |     |   |\   +-----------+
                              │         │  / +---+     +---+ \  │ Class     │
            +--------------+  │  Object │ /      locate       \ │ Structure │
            │ +------------+  │  Files  │ \      files        / │ Files     │
            │ │               │         │  \ +-------------+ /  +-----------+
            │ │               +---------+   \|             |/
            │ │                   ___                                ___
            │ │                   | |                                | |
            │ │                  _| |_                              _| |_
            │ │                  \   /                              \   /
            │ │                   \ /                                \ /
            │ │                    V                                  V
            │ │
            │ │              +-----------+
            │ │              │           │                       +----------+
            │ │              │           │                       │ Generate │
            │ │              │           │                       │ vtable   │
            │ │              │    nm     │                       │ update   │
            │ │              │           │                       │ code     │
            │ │              │           │                       +----------+
            │ │              │           │                           ___
            │ │              +-----------+                           | |
            │ │                   ___                                │ │
            │ │                   | |                                │ │
            │ │                  _| |_                               │ │
            │ │                  \   /                               │ │
            │ │                   \ /                                │ │
            │ │                    V                                 │ │
            │ │                                                      │ │
            │ │          +------------------+                        │ │
            │ │          │ Match up mangled │                        │ │
            │ │          │ and unmangled    │                        │ │
            │ │          │ names of traced  │                        │ │
            │ │          │ functions        │                        │ │
            │ │          +------------------+                        │ │
            │ │                   ___                                │ │
            │ │                   | |                                │ │
            │ │                  _| |_                               │ │
            │ │                  \   /                               │ │
            │ │                   \ /                                │ │
            │ │                    V                                 │ │
            │ │                                                      │ │
            │ │              +-----------+                           │ │
            │ │              │ List of   │                           │ │
            │ │       +----+ │ mangled   │                           │ │
            │ │       │ +--+ │ names of  │                           │ │
            │ │       │ │    │ traced    │                           │ │
            │ │       │ │    │ functions │                           │ │
            │ │       │ │    +-----------+                           │ │
            │ │       │ │         ___                                │ │
            │ │       │ │         | |                                │ │
            │ │       │ │        _| |_                              _│ │_
            │ │       │ │        \   /                              \   /
            │ │       │ │         \ /                                \ /
            │ │       │ │          V                                  V
            │ │       │ │
            │ │       │ │     +----------+           |\     +------------------+
            │ │       │ │     │ Generate │   +-------+ \    │                  │
            │ │       │ │     │ linker   │   |          \   │  Generated Code  │
            │ │       │ │     │ wrapper  │   |          /   │                  │
            │ │       │ │     │ code     │   +-------+ /    +------------------+
            │ │       │ │     +----------+           |/              ___
            │ │       │ │                                            | |
            │ │      _│ │_                                          _| |_
            │ │      \   /                                          \   /
            │ │       \ /                                            \ /
            │ │        V                                              V
            │ │
            │ │  +----------+                                   +----------+
            │ │  | Generate |                                   │          │
            │ │  | Linker   |                                   │ Compiler │
            │ │  | Options  |                                   │          │
            │ │  +----------+                                   +----------+
            | |       ___                                            ___
            | |       | |                                            | |
            | |       | |                                           _| |_
            | |       | |                                           \   /
            | |       | |                                            \ /
            | |       | |                                             V
            | |       | |
            | |       | |                                        +--------+
            | |       | |                                        │ Object │
            | |       | |                                        │ File   │
            | |       | |                                        +--------+
            │ │       │ │                                            ___
            │ │       │ │                                            | |
           _│ │_     _│ │_                                          _| |_
           \   /     \   /                                          \   /
            \ /       \ /                                            \ /
             V         V                                              V

          +------------------------------------------------------------------+
          │                                                                  │
          │                                                                  │
          │                              Linker                              │
          │                                                                  │
          │                                                                  │
          +------------------------------------------------------------------+
                                           ___
                                           | |
                                          _| |_
                                          \   /
                                           \ /
                                            V

                                    +--------------+
                                    │              │
                                    │  Executable  │
                                    │              │
                                    +--------------+
